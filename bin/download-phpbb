#!/bin/sh
# shellcheck shell=dash

#
# Downloads and extracts the latest stable phpBB version.
# Extracts the downloaded package in the given or the current directory.
#
# Requires curl, jq and tar with bzip2 support.
#
# Usage: ./get-phpbb.sh [dir]
#

echo "Exit immediately if a command exits with a non-zero status\n"
set -e

echo 'Init composer to see versions\n'
composer init --name 'noone/tmp-repo' --description 'tmp-repo' --author='Indianos'
echo 'Check which is the latest stable version\n'
LATEST_VERSION=$(composer show -la phpbb/phpbb | grep 'latest' | awk '{print $3}')

echo 'Define which directory to work with\n'
dir_to_check="/tmp/phpbb-$LATEST_VERSION"

echo 'Check if an old download was not left: '
if [ ! -d "$dir_to_check" ] || [ "$(find "$dir_to_check" -maxdepth 0 -type d -empty 2>/dev/null)" != "" ]; then
    echo 'dir does not exist or is empty - download files\n'
    composer create-project phpbb/phpbb $dir_to_check "$LATEST_VERSION"
else 
    echo 'there is something\n'
fi


echo 'Provide files to wanted directory '${1:-$PWD}
cp $dir_to_check ${1:-$PWD}
