#!/bin/sh
# shellcheck shell=dash

#
# Downloads and extracts the latest stable phpBB version.
# Extracts the downloaded package in the given or the current directory.
#
# Requires curl, jq and tar with bzip2 support.
#
# Usage: ./get-phpbb.sh [dir]
#

# Exit immediately if a command exits with a non-zero status:
set -e

# Check which is the latest stable version
#TODO: need to test and adjust with $BASE_VERSION set
# LATEST_VERSION=$(composer show phpbb/phpbb ${BASE_VERSION:---latest} | grep 'latest' | awk '{print $2}')
LATEST_VERSION=$(composer show phpbb/phpbb --latest | grep 'latest' | awk '{print $2}')

# Define which directory to work with
dir_to_check="/tmp/phpbb-$LATEST_VERSION"

# Check if an old download was not left
if [ -d "$dir_to_check" ] && [ "$(find "$dir_to_check" -maxdepth 0 -type d -empty 2>/dev/null)" = "" ]; then
    # dir exists and not empty
else
    # dir does not exist - download files
    composer install phpbb/phpbb $dir_to_check "$LATEST_VERSION"
fi

# Provide files to wanted directory
cp $dir_to_check ${1:-$PWD}
